/* Panthera Black Box Runtime v1.0.0 - Safe, Declarative Website Control */
"use strict";var PantheraBlackBox=(()=>{var c=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var p=Object.prototype.hasOwnProperty;var m=(o,e)=>{for(var t in e)c(o,t,{get:e[t],enumerable:!0})},u=(o,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of h(e))!p.call(o,n)&&n!==t&&c(o,n,{get:()=>e[n],enumerable:!(i=l(e,n))||i.enumerable});return o};var g=o=>u(c({},"__esModule",{value:!0}),o);var b={};m(b,{PantheraBlackBox:()=>r,default:()=>f});var r=class{constructor(e){this.config=null;this.initialized=!1;this.configUrl=e.configUrl,this.telemetryUrl=e.telemetryUrl,this.siteId=e.siteId}async init(){if(!this.initialized){fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"black-box/runtime.ts:53",message:"Black Box init started",data:{configUrl:this.configUrl,siteId:this.siteId},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{});try{let e=await fetch(this.configUrl,{method:"GET",headers:{Accept:"application/json"},cache:"no-cache"});if(fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"black-box/runtime.ts:64",message:"Config fetch response received",data:{ok:e.ok,status:e.status,statusText:e.statusText},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),!e.ok)throw new Error(`Failed to load config: ${e.status}`);let t=await e.json();if(fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"black-box/runtime.ts:72",message:"Config JSON parsed",data:{hasPantheraBlackbox:!!t.panthera_blackbox,hasSite:!!t.panthera_blackbox?.site,brand:t.panthera_blackbox?.site?.brand,telemetryEmit:t.panthera_blackbox?.telemetry?.emit},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),!t.panthera_blackbox||!t.panthera_blackbox.site)throw new Error("Invalid config structure");this.config=t,this.initialized=!0,this.applyConfig(),fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"black-box/runtime.ts:85",message:"Config applied",data:{initialized:this.initialized,telemetryEmit:this.config.panthera_blackbox.telemetry?.emit},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}),this.config.panthera_blackbox.telemetry?.emit&&(this.startTelemetry(),fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"black-box/runtime.ts:90",message:"Telemetry started",data:{telemetryUrl:this.telemetryUrl},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{}))}catch(e){console.error("[Panthera Black Box] Initialization failed:",e),fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"black-box/runtime.ts:95",message:"Black Box init failed",data:{error:e instanceof Error?e.message:String(e)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{})}}}applyConfig(){if(!this.config)return;let e=this.config.panthera_blackbox;fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"black-box/runtime.ts:95",message:"applyConfig called",data:{hasConfig:!!this.config,brand:e.site?.brand,telemetryEmit:e.telemetry?.emit,autofillEnabled:e.autofill?.enabled,hasAds:!!e.ads?.slots},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{}),this.injectSchema(e),e.autofill?.enabled&&e.autofill.forms&&this.initializeAutoFill(e),e.ads?.slots&&this.initializeAdSlots(e),fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"black-box/runtime.ts:112",message:"applyConfig completed",data:{schemaInjected:!!document.querySelector("script[data-panthera]")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"E"})}).catch(()=>{})}injectSchema(e){if(typeof document>"u")return;document.querySelectorAll('script[type="application/ld+json"][data-panthera]').forEach(s=>s.remove());let i=e.tier??"bronze";this.generateSchemasForTier(e,i).forEach((s,a)=>{let d=document.createElement("script");d.type="application/ld+json",d.setAttribute("data-panthera","true"),d.setAttribute("data-schema-index",a.toString()),d.textContent=JSON.stringify(s),document.head.appendChild(d)})}generateSchemasForTier(e,t){let i=[],n={"@context":"https://schema.org","@type":"Organization",name:e.site.brand,url:`https://${e.site.domain}`};if(e.authority_grove?.node&&(n.sameAs=e.authority_grove.node.sameAs,n.keywords=e.authority_grove.node.keywords),i.push(n),(t==="silver"||t==="gold")&&(e.products&&e.products.forEach(a=>{i.push({"@context":"https://schema.org","@type":"Product",name:a.name||e.site.brand,description:a.description,brand:{"@type":"Brand",name:e.site.brand},url:`https://${e.site.domain}`})}),e.services&&e.services.forEach(a=>{i.push({"@context":"https://schema.org","@type":"Service",name:a.name||e.site.brand,description:a.description,provider:{"@type":"Organization",name:e.site.brand,url:`https://${e.site.domain}`}})}),e.site.geo&&e.site.geo.length>0&&i.push({"@context":"https://schema.org","@type":"LocalBusiness",name:e.site.brand,url:`https://${e.site.domain}`,areaServed:e.site.geo}),e.faqs)){let s=e.faqs;s.length>0&&i.push({"@context":"https://schema.org","@type":"FAQPage",mainEntity:s.map(a=>({"@type":"Question",name:a.question,acceptedAnswer:{"@type":"Answer",text:a.answer}}))})}return i}initializeAutoFill(e){typeof window>"u"||!e.autofill?.forms||e.autofill.forms.forEach(t=>{let i=document.querySelector(t.selector);i&&(i.pantheraAutoFill=t,i.addEventListener("focusin",n=>{let s=n.target;(s.tagName==="INPUT"||s.tagName==="TEXTAREA"||s.tagName==="SELECT")&&this.triggerAutoFill(t)},{once:!0}))})}async triggerAutoFill(e){let t={},i=document.querySelector(e.selector);if(i)for(let[n,s]of Object.entries(e.map)){let a=i.querySelector(s);a&&t[n]&&(a.value=t[n],a.dispatchEvent(new Event("input",{bubbles:!0})))}}initializeAdSlots(e){typeof window>"u"||!e.ads?.slots||e.ads.slots.forEach(t=>{fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"runtime.ts:226",message:"initializeAdSlots - original slot.id",data:{slotId:t.id,slotIdType:typeof t.id,slotIdString:String(t.id),slotIdJSON:JSON.stringify(t.id)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{});let i=String(t.id||"").trim();if(i=i.replace(/["']/g,""),i=i.trim(),fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"runtime.ts:232",message:"initializeAdSlots - after sanitization",data:{sanitizedId:i,originalSlotId:t.id,sanitizedLength:i.length},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),!i){fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"runtime.ts:236",message:"initializeAdSlots - empty after sanitization",data:{originalSlotId:t.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{});return}try{let n=i.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g,"\\$&");if(n.includes('"')||n.includes("'"))throw fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"runtime.ts:243",message:"initializeAdSlots - quotes detected in escapedId",data:{escapedId:n,sanitizedId:i,originalSlotId:t.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{}),new Error(`Slot ID contains quotes after sanitization: ${n}`);let s=`[data-ad-slot="${n}"]`;fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"runtime.ts:250",message:"initializeAdSlots - selector construction",data:{escapedId:n,selector:s,selectorLength:s.length,selectorChars:Array.from(s)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{});let a=document.querySelector(s);a?(a.pantheraAdSlot=t,this.loadAdCreative(t)):fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"runtime.ts:262",message:"initializeAdSlots - element not found",data:{selector:s,escapedId:n},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"D"})}).catch(()=>{})}catch(n){fetch("http://127.0.0.1:7251/ingest/f2bef142-91a5-4d7a-be78-4c2383eb5638",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"runtime.ts:267",message:"initializeAdSlots - error caught",data:{error:String(n),errorMessage:n.message,slotId:t.id,sanitizedId:i,escapedId:i.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g,"\\$&"),selector:`[data-ad-slot="${i.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g,"\\$&")}"]`},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{}),console.error(`[Panthera Black Box] Invalid ad slot selector for ID: ${t.id}`,n)}})}async loadAdCreative(e){console.debug("[Panthera Black Box] Ad slot initialized:",e.id)}startTelemetry(){if(this.config?.panthera_blackbox.telemetry?.emit&&(this.sendTelemetry("page_view",{url:window.location.href,referrer:document.referrer}),typeof window<"u")){let e=null,t=()=>{e||(e=window.setTimeout(()=>{this.sendTelemetry("interaction",{timestamp:new Date().toISOString()}),e=null},1e3))};document.addEventListener("click",t,{passive:!0}),document.addEventListener("scroll",t,{passive:!0})}}async sendTelemetry(e,t){if(!this.config?.panthera_blackbox.telemetry?.emit)return;let i={schema:"panthera.blackbox.v1",tenant:this.config.panthera_blackbox.site.domain,timestamp:new Date().toISOString(),source:"blackbox",context:{event_type:e,...t},metrics:this.collectMetrics()};try{if(navigator.sendBeacon){let n=new Blob([JSON.stringify(i)],{type:"application/json"});navigator.sendBeacon(this.telemetryUrl,n)}else await fetch(this.telemetryUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),keepalive:!0})}catch(n){console.debug("[Panthera Black Box] Telemetry failed:",n)}}collectMetrics(){let e={};return(this.config?.panthera_blackbox.telemetry?.keys||[]).forEach(i=>{i.startsWith("ts.")?e[i]=.5+Math.random()*.4:i.startsWith("ai.")?e[i]=.6+Math.random()*.35:e[i]=0}),e}getConfig(){return this.config}async reload(){this.initialized=!1,await this.init()}};(function(){if(typeof window>"u")return;let o=document.currentScript;if(!o)return;let e=o.getAttribute("data-config-url"),t=o.getAttribute("data-telemetry-url"),i=o.getAttribute("data-site-id");if(!e||!t||!i){console.warn("[Panthera Black Box] Missing required data attributes");return}let n=new r({configUrl:e,telemetryUrl:t,siteId:i});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>n.init()):n.init(),window.PantheraBlackBox=r,window.panthera=n})();var f=r;return g(b);})();
//# sourceMappingURL=runtime.global.js.map